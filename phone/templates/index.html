<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#ffffff">
    <title>抽獎系統</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">



</head>
<body>
    <div class="header">
        <h1>抽獎系統</h1>
        <a href="{{ url_for('setup') }}" class="setup-button">前往設定畫面</a>
        <!-- 剩餘獎品按鈕 -->
        <button id="remaining-button" class="remaining-button" onclick="openRemainingModal()">查看剩餘獎品</button>

        <!-- 歷史紀錄按鈕，放在右下角 -->
        <button id="history-btn" onclick="showHistory()">歷史紀錄</button>

        <!-- 回朔功能按鈕 -->
        <button id="undo-btn" onclick="confirmUndo()">回朔</button>

        <!-- 歷史紀錄彈窗 -->
        <div id="history-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeHistory()">&times;</span>
                <h2>抽獎紀錄</h2>
                <ul id="history-list">
                    <!-- 抽獎紀錄項目將在這裡動態插入 -->
                </ul>
            </div>
        </div>
    </div>

    
    
    <div id="prizes-container">
        {% if prizes %}
            <div id="prizes">
                {% for prize in prizes %}
                    <button class="ticket" onclick="drawPrize(this)">
                        <!-- {{ loop.index }} -->
                        <img src="{{ url_for('static', filename='images/ticket.png') }}" alt="抽籤圖標">
                    </button>
                {% endfor %}
            </div>
            <div id="result"></div>
        {% else %}
            <p>請先設置獎品後再進行抽獎。</p>
        {% endif %}
    </div>

    <!-- 剩餘獎品的彈出視窗 -->
    <div id="remaining-modal" class="modal">
        <div class="modal-content">
            <img src="{{ url_for('static', filename='images/header.png') }}" alt="Header Image" class="modal-header-image">
            <span class="close" onclick="closeRemainingModal()">< 返回</span>
            <h3>剩餘獎品</h3>
            <div id="remaining-content">
                <!-- 剩餘獎品內容將在此更新 -->
            </div>
        </div>
    </div>

    <script>
        const initialRemaining = {{ remaining | tojson }};
        
        // 抽獎彈窗開關狀態
        let isPopupEnabled = document.getElementById("toggle-draw-popup").checked;

        // 當開關狀態改變時更新 isPopupEnabled
        document.getElementById("toggle-draw-popup").addEventListener("change", function() {
            isPopupEnabled = this.checked;
        });

        function drawPrize(button) {
            fetch("{{ url_for('draw') }}", { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById("result").textContent = data.error;
                    } else {
                        button.textContent = data.prize;
                        button.disabled = true;
                        
                        // 更新抽中的獎項顯示在彈窗中
                        document.getElementById("draw-result").innerHTML = `<p>您抽中了：${data.prize}</p>`;
                        
                        // 檢查開關是否開啟彈窗
                        if (isPopupEnabled) {
                            showDrawModal(); // 顯示抽獎結果彈窗
                        }

                        // 新增歷史紀錄
                        addHistoryRecord(data.prize);
                        
                        // 更新剩餘獎品數量
                        updateRemaining(data.remaining);
                    }
                });
        }

        function showDrawModal(prize) {
            // 更新第一個彈窗內容
            document.getElementById("prize-name").textContent = prize;
            document.getElementById("draw-modal").style.display = "flex";
        }

        function showConfirmPrizeModal() {
            // 關閉第一個彈窗，顯示第二個彈窗
            document.getElementById("draw-modal").style.display = "none";
        }



        function updateRemaining(remaining) {
            const remainingDiv = document.getElementById("remaining");
            remainingDiv.innerHTML = "<h3>剩餘獎品</h3>";
            if (Object.values(remaining).every(count => count === 0)) {
                remainingDiv.innerHTML += "<p>沒有獎品了</p>";
            } else {
                for (const [prize, count] of Object.entries(remaining)) {
                    remainingDiv.innerHTML += `<p>${prize}: ${count}個</p>`;
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            updateRemaining(initialRemaining);
        });

        // 剩餘獎品視窗的開關
        function openRemainingModal() {
            document.getElementById("remaining-modal").style.display = "flex";
            fetch("{{ url_for('remaining') }}")
                .then(response => response.json())
                .then(data => {
                    const remainingContent = document.getElementById("remaining-content");
                    remainingContent.innerHTML = "";
                    if (Object.values(data).every(count => count === 0)) {
                        remainingContent.innerHTML = "<p>沒有獎品了</p>";
                    } else {
                        for (const [prize, count] of Object.entries(data)) {
                            remainingContent.innerHTML += `<p>${prize}: ${count}個</p>`;
                        }
                    }
                });
        }

        function closeRemainingModal() {
            document.getElementById("remaining-modal").style.display = "none";
        }

        // 抽獎後，新增紀錄
        function addHistoryRecord(prize) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-Hant', { hour12: false }); // 格式化為 24 小時制
            const record = `${timeString}, 獎品：${prize}`;
            
            historyRecords.unshift(record); // 加入到歷史紀錄陣列的開頭
            updateHistoryList(); // 更新彈窗的顯示
        }

        // 更新彈窗中的歷史紀錄列表
        function updateHistoryList() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = ""; // 清空原有的列表內容

            historyRecords.forEach(record => {
                const listItem = document.createElement('li');
                listItem.textContent = record;
                historyList.appendChild(listItem);
            });
        }

        // 顯示歷史紀錄彈窗
        function showHistory() {
            document.getElementById('history-modal').style.display = 'flex';
        }

        // 清除歷史紀錄
        function clearHistory() {
            if (confirm("確定要清除所有歷史紀錄嗎？")) {
                fetch('/clear_history', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message); // 顯示清除成功訊息
                        currentPage = 1; // 重置到第一頁
                        updateHistoryList(); // 清空列表
                    });
            }
        }

        // 關閉歷史紀錄彈窗
        function closeHistory() {
            document.getElementById('history-modal').style.display = 'none';
        }
        
        // 回朔功能：將最後一次抽到的籤放回到獎品池
        function confirmUndo() {
            // 顯示確認視窗
            const confirmAction = confirm("確定要回朔上一個抽出的籤嗎？");
            if (confirmAction) {
                // 如果用戶選擇「確定」，則執行回朔操作
                fetch('/undo_draw', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            alert(data.message);
                            location.reload(); // 回朔成功後重新載入頁面
                        }
                    })
                    .catch(error => {
                        console.error("回朔時發生錯誤:", error);
                        alert("回朔失敗，請稍後再試！");
                    });
            } else {
                // 如果用戶選擇「取消」，則不進行任何操作
                alert("回朔已取消");
            }
        }

    </script>
</body>
</html>
